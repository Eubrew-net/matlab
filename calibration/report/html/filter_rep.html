
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
      <!--
This HTML is auto-generated from an M-file.
To make changes, update the M-file and republish this document.
      -->
      <title>Filter Report form FIOAVGG</title>
      <meta name="generator" content="MATLAB 7.7">
      <meta name="date" content="2009-03-17">
      <meta name="m-file" content="filter_rep"><style type="text/css">

body {
  background-color: white;
  margin:10px;
}

h1 {
  color: #990000; 
  font-size: x-large;
}

h2 {
  color: #990000;
  font-size: medium;
}

/* Make the text shrink to fit narrow windows, but not stretch too far in 
wide windows. */ 
p,h1,h2,div.content div {
  max-width: 600px;
  /* Hack for IE6 */
  width: auto !important; width: 600px;
}

pre.codeinput {
  background: #EEEEEE;
  padding: 10px;
}
@media print {
  pre.codeinput {word-wrap:break-word; width:100%;}
} 

span.keyword {color: #0000FF}
span.comment {color: #228B22}
span.string {color: #A020F0}
span.untermstring {color: #B20000}
span.syscmd {color: #B28C00}

pre.codeoutput {
  color: #666666;
  padding: 10px;
}

pre.error {
  color: red;
}

p.footer {
  text-align: right;
  font-size: xx-small;
  font-weight: lighter;
  font-style: italic;
  color: gray;
}

  </style></head>
   <body>
      <div class="content">
         <h1>Filter Report form FIOAVGG</h1>
         <p>function [ETC_FILTER_CORRECTION,media,fi]=filter_rep(brw_str) IOS description of the fi test output in fioavg.### file (created
            by V. Savastiouk)
         </p>
         <p>date Te  AF CY  N  Slit0 std Slit1 std Slit2 std Slit3 std  Slit4  std Slit5 std 28003 9  1   1  3  49815 +37 59776 +0  60031
            +0  60318  +0  59622  +0  58465 +0          2   3  3  4520  +17  4514 +13  4504 +5   4492  +7   4482  +5   4474 +16      
            3   8  3  9386  +16  9338 +24  9296 +3   9245  +7   9211  +6   9186 +22          4  30  3 16396  +24 16262 +17 16105 +17 15976
            +7  15863 +11  15752 +7          5 100  3 24598  +55 24357 +9  24155 +18 24003  +9  23873  +9  23736 +13          6 250  3
            25996  +54 25764 +0  25553 +13 25411  +0  25251  +0  25103 +13
         </p>
         <p>Te - temperature, AF - FW2 position, CY-number of cycles for that AF N - number of repetition (fi does several loops one inside
            the other and N is the outer most loop). Slit0-6 are the values for the attenuations, except for AF=1 where it represents
            the absolute intensity. avgfech-&gt; fi_avg 1      2   3           4 date,year,julian_day,temp,  5    6  7   8    9    10   11
                12   13    14   15      16  17  AF  CY  N  sl0 ssl0   sl_1 ssl_1  sl_2 ssl_2 sl_3 ssl_3  sl_4 ssl_4             sl_5 ssl_5
            TODO: Add date range selection
         </p><pre class="codeinput"><span class="keyword">function</span> [ETC_FILTER_CORRECTION,media,fi]=filter_rep(brw_str,date_range)


<span class="comment">% Los ficheros FIOAVG.nnn pueden tener 2 tipos de errores:</span>
<span class="comment">%  1) el software brewer es incapaz de reconocer ciertos registros. En estos casos suele</span>
<span class="comment">%     aparecer un % en el campo afectado.</span>
<span class="comment">%  2) errores de fecha.</span>
<span class="comment">% Para que el programa funcione tendremos que editar el fichero y corregir</span>
<span class="comment">% manualmente los registros afectados por el error dado en 2. Los errores descritos en 1</span>
<span class="comment">% son superados por el script read_avg_line</span>

fioavg=[<span class="string">'.'</span>,filesep(),<span class="string">'bdata'</span>, brw_str,filesep(),<span class="string">'FIOAVG.'</span>,brw_str];

<span class="keyword">try</span>
 a=textread(fioavg,<span class="string">''</span>);
<span class="keyword">catch</span>
  <span class="keyword">try</span>
    a=read_avg_line(fioavg);
    <span class="keyword">catch</span>
     disp(fioavg);
     aux=lasterror;
     disp(aux.message)
     <span class="keyword">return</span>;
  <span class="keyword">end</span>
<span class="keyword">end</span>
<span class="comment">% FIOAVG=load(fioavg)</span>
fi_avg=avgfech(a); fech=datevec(fi_avg(:,1));
<span class="keyword">if</span> nargin&gt;1
  fi_avg(find(fi_avg(:,1)&lt;date_range(1)),:)=[];
  <span class="keyword">if</span> length(date_range)&gt;1
   fi_avg(find(fi_avg(:,1)&gt;date_range(2)),:)=[];
  <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">% IOS description of the fi test output in fioavg.### file (created by V. Savastiouk)</span>
<span class="comment">%</span>
<span class="comment">% date Te  AF CY  N  Slit0 std Slit1 std Slit2 std Slit3 std  Slit4  std Slit5 std</span>
<span class="comment">% 28003 9  1   1  3  49815 +37 59776 +0  60031 +0  60318  +0  59622  +0  58465 +0</span>
<span class="comment">%          2   3  3  4520  +17  4514 +13  4504 +5   4492  +7   4482  +5   4474 +16</span>
<span class="comment">%          3   8  3  9386  +16  9338 +24  9296 +3   9245  +7   9211  +6   9186 +22</span>
<span class="comment">%          4  30  3 16396  +24 16262 +17 16105 +17 15976  +7  15863 +11  15752 +7</span>
<span class="comment">%          5 100  3 24598  +55 24357 +9  24155 +18 24003  +9  23873  +9  23736 +13</span>
<span class="comment">%          6 250  3 25996  +54 25764 +0  25553 +13 25411  +0  25251  +0  25103 +13</span>
<span class="comment">%</span>
<span class="comment">% Te - temperature,</span>
<span class="comment">% AF - FW2 position,</span>
<span class="comment">% CY-number of cycles for that AF</span>
<span class="comment">% N - number of repetition (fi does several loops one inside the other and N is the</span>
<span class="comment">% outer most loop). Slit0-6 are the values for the attenuations, except for AF=1</span>
<span class="comment">% where it represents the absolute intensity.</span>
<span class="comment">% avgfech-&gt; fi_avg</span>
<span class="comment">% 1      2   3           4</span>
<span class="comment">% date,year,julian_day,temp,</span>
<span class="comment">%  5    6  7   8    9    10   11     12   13    14   15      16  17</span>
<span class="comment">%  AF  CY  N  sl0 ssl0   sl_1 ssl_1  sl_2 ssl_2 sl_3 ssl_3  sl_4 ssl_4</span>
<span class="comment">%  sl_5 ssl_5</span>
<span class="comment">%  18   19</span>
<span class="comment">% 15 campos por 6 slits</span>
<span class="comment">%  Filter,cy,N,sl0 ssl0 sl_1 ssl_1 sl_2 ssl_2 sl_3 ssl_3 sl_4 ssl_4 sl_5</span>
<span class="comment">%</span>
<span class="comment">%   1,2,3       4   5       6   7       8    9    10   11    12   13</span>
<span class="keyword">try</span>
 fi=reshape(fi_avg(:,5:end),[],15,6);
<span class="keyword">catch</span>
 <span class="comment">%edited files !!</span>
 fi=reshape(fi_avg(:,5:end-2),[],15,6);
<span class="keyword">end</span>
<span class="comment">% dim 1 n de medidas</span>
<span class="comment">%    2 medidas (slit 0-5) 15 datos</span>
<span class="comment">%    3 medidas por filtro</span>

<span class="comment">% ya son directamente las atenuaciones.</span>
<span class="comment">% nominal values</span>
nominal=[1,5000,10000,15000,20000,25000];
<span class="comment">%nominal=[   1 ,4370,10250,14150,21800,26400];</span>
ref=fi(:,4:2:end,1);
temp=repmat(fi_avg(:,4),1,6);
dia=repmat(fi_avg(:,3),1,6); records = size(dia,1);
lamda=[3032.06 3063.01 3100.53 3135.07 3168.09 3199.98];
f=1:5; <span class="comment">%filtro</span>
label_lamda=num2str(fix(lamda'/10));
nmeas=size(fi,1);




<span class="keyword">if</span> nmeas==1
    fi(2,:,:)=fi(1,:,:);
    nmeas=2;
<span class="keyword">end</span>

fh=figure;
set(fh,<span class="string">'tag'</span>,<span class="string">'FI_TIME'</span>);

<span class="comment">%mmplotyy(fi_avg(:,1),ref,'.:',temp,'-*');</span>
<span class="comment">%mmplotyy('temperature');</span>
<span class="comment">%grid;</span>
<span class="comment">%datetick('x','mmm/dd','keeplimits','keepticks')</span>


<span class="keyword">for</span> ii=1:6
  subplot(2,3,ii);
  <span class="comment">%plot(dia,((fi(:,4:2:end,ii)-repmat(nominal(ii),[nmeas,6]))./repmat(nominal(ii),[nmeas,6])));</span>
  mmplotyy(dia(:,1),fi(:,4:2:end,ii),temp);
  axis(<span class="string">'tight'</span>);
  xlabel(<span class="string">'Day'</span>)
<span class="keyword">end</span>

legend(label_lamda);

mmplotyy(<span class="string">'shrink'</span>);


fh=figure;
set(fh,<span class="string">'tag'</span>,<span class="string">'FI_STATS'</span>);

<span class="keyword">for</span> ii=1:6
  subplot(2,3,ii);
  boxplot(100*((fi(:,4:2:end,ii)-repmat(nominal(ii),[nmeas,6]))./repmat(nominal(ii),[nmeas,6])),<span class="keyword">...</span>
          <span class="string">'label'</span>,label_lamda);
  <span class="comment">%    pos_ytext=get(gca,'YTick');</span>
  <span class="comment">%    pos_xtext=get(gca,'XTick');</span>
  <span class="comment">%set(gca,'FOntsize',8,'FontWeight','bold');</span>
  xlabel(<span class="string">'wavelength'</span>,<span class="string">'FontSize'</span>,11,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>)
  <span class="comment">%if ii&lt;5</span>
      ylabel(sprintf(<span class="string">'%s\n%s'</span>,<span class="string">'%difference from '</span>,<span class="string">'nominal values'</span>),<span class="string">'FontSize'</span>,11,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
      title(sprintf(<span class="string">'Filter #%d'</span>,ii-1),<span class="string">'FontSize'</span>,10,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
      <span class="comment">%text(pos_xtext(end-2),pos_ytext(1),sprintf('Filter #%d',ii-1),'FontSize',10,'FontWeight','bold');</span>
      <span class="keyword">if</span> ii==1
      ylabel(<span class="string">'Intensity'</span>,<span class="string">'FontSize'</span>,11,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
      title(<span class="string">'Intensity'</span>,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
      <span class="comment">%text(pos_xtext(end-2),pos_ytext(1),'Filter #0','FontSize',10,'FontWeight','bold');</span>
      <span class="keyword">end</span>
  <span class="comment">%else</span>
  <span class="comment">%    ylabel(sprintf('%s\n%s','%difference from ','nominal values'),'FontSize',11,'FontWeight','bold');</span>
  <span class="comment">%      text(pos_xtext(1),pos_ytext(1),sprintf('Filter #%d',ii-1),'FontSize',10,'FontWeight','bold');</span>
  <span class="comment">%end</span>
<span class="keyword">end</span>
sup=suptitle(sprintf(<span class="string">'%s%s'</span>,<span class="string">'Attenuation Filter Test, '</span>,fioavg(regexp(fioavg,<span class="string">'AVG'</span>)-3:regexp(fioavg,<span class="string">'AVG'</span>)+6)));
pos=get(sup,<span class="string">'Position'</span>);
set(sup,<span class="string">'Handlevisibility'</span>,<span class="string">'off'</span>,<span class="string">'Position'</span>,[pos(1)+.02,pos(2)-.01,1]);
orient(<span class="string">'landscape'</span>);
<span class="comment">%</span>
media=squeeze(fix(median(fi(:,4:2:end,2:end),1)));

med=[[0,fix(lamda/10)]',[f;media],];
a=mat2clip(med);

label_1={<span class="string">'FIOAVG '</span>,<span class="string">'slit #0'</span>,<span class="string">'slit #1'</span>,<span class="string">'slit #2'</span>,<span class="string">'slit #3'</span>,<span class="string">'slit #4'</span>,<span class="string">'slit #5'</span>,<span class="string">'mean'</span>};
label_2={<span class="string">'filter #1'</span>,<span class="string">'filter #2'</span>,<span class="string">'filter #3'</span>,<span class="string">'filter #4'</span>,<span class="string">'filter #5'</span>};

filter_table=[label_1',[label_2;num2cell(media);num2cell(fix(mean(media)))]];
makeHtmlTable([fix(media);fix(mean(media))],[],label_1,label_2 );



<span class="comment">% ETC correction</span>
<span class="comment">% ETC(FILTER)= SUM  W(L)* AFC(L,F)</span>
<span class="comment">% AFC=  Attenuation Filter Correction</span>
<span class="comment">% AFC(F,L)= NOMINAL(F)-REAL(F,L)</span>

<span class="comment">%AFC</span>
O3W=[   0.00      0.00   -1.00    0.50    2.20   -1.70];
SO2W=[  0.00    -1.00    0.00    0.00    4.20   -3.20];



ETC_FILTER_CORRECTION=round(O3W*media);

<span class="comment">%printmatrix(ETC_FILTER_CORRECTION)</span>
table_filter_correction=[label_2;num2cell(round(ETC_FILTER_CORRECTION))];

makeHtmlTable(ETC_FILTER_CORRECTION,[],{<span class="string">'ETC FILTER CORR'</span>},label_2 );

<span class="comment">% media</span>
<span class="comment">%media;mat2clip(fix(mean(media)),'%5d')</span>
f=figure;
set(f,<span class="string">'tag'</span>,<span class="string">'FI wavelength'</span>);
r=matdiv(100*matadd(media,-mean(media)),media);

plot(lamda,r,<span class="string">'.:'</span>,<span class="string">'Markersize'</span>,25);
hold <span class="string">on</span>; plot(lamda,mean(r,2),<span class="string">'s:'</span>,<span class="string">'Markersize'</span>,12);
legend(<span class="string">'filter 1'</span>,<span class="string">'filter 2'</span>,<span class="string">'filter 3'</span>,<span class="string">'filter 4'</span>,<span class="string">'filter 5'</span>,<span class="string">'mean'</span>,-1)

<span class="comment">%l1=rline; set(findobj('Type','text'),'Visible','off'); set(l1,'Linewidth',1.5);</span>
<span class="comment">%set(l1(1),'Linewidth',5);</span>
<span class="comment">%set(findobj('Type','line'),'Handlevisibility','off')</span>

set(gca,<span class="string">'XLim'</span>,[3020 3200],<span class="string">'FontSize'</span>,11,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
ylabel(<span class="string">'Differences to mean %'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>)
xlabel(<span class="string">'wavelenght nm'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>)
sup=title({[<span class="string">'Wavelength dependence of the attenuation filter,  #'</span>, brw_str],[<span class="string">'ETC filter corr=[ '</span>,num2str(ETC_FILTER_CORRECTION),<span class="string">']'</span>]});
pos=get(sup,<span class="string">'Position'</span>);
set(sup,<span class="string">'Position'</span>,[pos(1)-.03,pos(2)-.03,1],<span class="string">'FontSize'</span>,15);box <span class="string">off</span>
legend(<span class="string">'filter 1'</span>,<span class="string">'filter 2'</span>,<span class="string">'filter 3'</span>,<span class="string">'filter 4'</span>,<span class="string">'filter 5'</span>,<span class="string">'mean'</span>,-1)
grid;

<span class="comment">% ETC correction</span>
<span class="comment">% ETC(FILTER)= SUM  W(L)* AFC(L,F)</span>
<span class="comment">% AFC=  Attenuation Filter Co/home/aredondasrrection</span>
<span class="comment">% AFC(F,L)= NOMINAL(F)-REAL(F,L)</span>

<span class="comment">%AFC</span>
<span class="comment">%O3W=[   0.00      0.00   -1.00    0.50    2.20   -1.70];</span>
<span class="comment">%SO2W=[  0.00    -1.00    0.00    0.00    4.20   -3.20];</span>

<span class="comment">%AFC=media-repmat(media(:,3),1,5);</span>
<span class="comment">%AFC=((media-repmat(mean(media),6,1)));</span>
<span class="comment">%AFC2=((media-repmat(nominal(2:end),6,1)));</span>
<span class="comment">%ETCF=O3W*AFC;</span>
<span class="comment">% ETC correction</span>

<span class="comment">%printmatrix(media,2);</span>
<span class="comment">%ETC_FILTER_CORRECTION=O3W*media;</span>
<span class="comment">%printmatrix(ETC_FILTER_CORRECTION);</span>
</pre><pre class="codeoutput">Input argument "brw_str" is undefined.

Error in ==&gt; filter_rep at 38
fioavg=['.',filesep(),'bdata', brw_str,filesep(),'FIOAVG.',brw_str];
</pre><p class="footer"><br>
            Published with MATLAB&reg; 7.7<br></p>
      </div>
      <!--
##### SOURCE BEGIN #####
%% Filter Report form FIOAVGG
% function [ETC_FILTER_CORRECTION,media,fi]=filter_rep(brw_str)
% IOS description of the fi test output in fioavg.### file (created by V. Savastiouk)
% 
% date Te  AF CY  N  Slit0 std Slit1 std Slit2 std Slit3 std  Slit4  std Slit5 std
% 28003 9  1   1  3  49815 +37 59776 +0  60031 +0  60318  +0  59622  +0  58465 +0 
%          2   3  3  4520  +17  4514 +13  4504 +5   4492  +7   4482  +5   4474 +16 
%          3   8  3  9386  +16  9338 +24  9296 +3   9245  +7   9211  +6   9186 +22 
%          4  30  3 16396  +24 16262 +17 16105 +17 15976  +7  15863 +11  15752 +7 
%          5 100  3 24598  +55 24357 +9  24155 +18 24003  +9  23873  +9  23736 +13 
%          6 250  3 25996  +54 25764 +0  25553 +13 25411  +0  25251  +0  25103 +13
% 
% Te - temperature,
% AF - FW2 position,
% CY-number of cycles for that AF
% N - number of repetition (fi does several loops one inside the other and N is the 
% outer most loop). Slit0-6 are the values for the attenuations, except for AF=1 
% where it represents the absolute intensity.
% avgfech-> fi_avg
% 1      2   3           4
% date,year,julian_day,temp, 
%  5    6  7   8    9    10   11     12   13    14   15      16  17
%  AF  CY  N  sl0 ssl0   sl_1 ssl_1  sl_2 ssl_2 sl_3 ssl_3  sl_4 ssl_4 
%             sl_5 ssl_5 
% TODO: Add date range selection

function [ETC_FILTER_CORRECTION,media,fi]=filter_rep(brw_str,date_range)


% Los ficheros FIOAVG.nnn pueden tener 2 tipos de errores:
%  1) el software brewer es incapaz de reconocer ciertos registros. En estos casos suele 
%     aparecer un % en el campo afectado.
%  2) errores de fecha.
% Para que el programa funcione tendremos que editar el fichero y corregir
% manualmente los registros afectados por el error dado en 2. Los errores descritos en 1
% son superados por el script read_avg_line

fioavg=['.',filesep(),'bdata', brw_str,filesep(),'FIOAVG.',brw_str];

try
 a=textread(fioavg,'');
catch
  try
    a=read_avg_line(fioavg);   
    catch
     disp(fioavg);   
     aux=lasterror;
     disp(aux.message)
     return;
  end
end
% FIOAVG=load(fioavg)
fi_avg=avgfech(a); fech=datevec(fi_avg(:,1));
if nargin>1
  fi_avg(find(fi_avg(:,1)<date_range(1)),:)=[];
  if length(date_range)>1
   fi_avg(find(fi_avg(:,1)>date_range(2)),:)=[];
  end
end

% IOS description of the fi test output in fioavg.### file (created by V. Savastiouk)
% 
% date Te  AF CY  N  Slit0 std Slit1 std Slit2 std Slit3 std  Slit4  std Slit5 std
% 28003 9  1   1  3  49815 +37 59776 +0  60031 +0  60318  +0  59622  +0  58465 +0 
%          2   3  3  4520  +17  4514 +13  4504 +5   4492  +7   4482  +5   4474 +16 
%          3   8  3  9386  +16  9338 +24  9296 +3   9245  +7   9211  +6   9186 +22 
%          4  30  3 16396  +24 16262 +17 16105 +17 15976  +7  15863 +11  15752 +7 
%          5 100  3 24598  +55 24357 +9  24155 +18 24003  +9  23873  +9  23736 +13 
%          6 250  3 25996  +54 25764 +0  25553 +13 25411  +0  25251  +0  25103 +13
% 
% Te - temperature,
% AF - FW2 position,
% CY-number of cycles for that AF
% N - number of repetition (fi does several loops one inside the other and N is the 
% outer most loop). Slit0-6 are the values for the attenuations, except for AF=1 
% where it represents the absolute intensity.
% avgfech-> fi_avg
% 1      2   3           4
% date,year,julian_day,temp, 
%  5    6  7   8    9    10   11     12   13    14   15      16  17
%  AF  CY  N  sl0 ssl0   sl_1 ssl_1  sl_2 ssl_2 sl_3 ssl_3  sl_4 ssl_4 
%  sl_5 ssl_5 
%  18   19   
% 15 campos por 6 slits
%  Filter,cy,N,sl0 ssl0 sl_1 ssl_1 sl_2 ssl_2 sl_3 ssl_3 sl_4 ssl_4 sl_5
%  
%   1,2,3       4   5       6   7       8    9    10   11    12   13  
try
 fi=reshape(fi_avg(:,5:end),[],15,6);
catch
 %edited files !!   
 fi=reshape(fi_avg(:,5:end-2),[],15,6);
end
% dim 1 n de medidas
%    2 medidas (slit 0-5) 15 datos
%    3 medidas por filtro 

% ya son directamente las atenuaciones.
% nominal values
nominal=[1,5000,10000,15000,20000,25000];
%nominal=[   1 ,4370,10250,14150,21800,26400];
ref=fi(:,4:2:end,1);
temp=repmat(fi_avg(:,4),1,6);
dia=repmat(fi_avg(:,3),1,6); records = size(dia,1);
lamda=[3032.06 3063.01 3100.53 3135.07 3168.09 3199.98];
f=1:5; %filtro
label_lamda=num2str(fix(lamda'/10));
nmeas=size(fi,1);




if nmeas==1
    fi(2,:,:)=fi(1,:,:);
    nmeas=2;
end

fh=figure;
set(fh,'tag','FI_TIME');

%mmplotyy(fi_avg(:,1),ref,'.:',temp,'-*');
%mmplotyy('temperature');
%grid;
%datetick('x','mmm/dd','keeplimits','keepticks')


for ii=1:6
  subplot(2,3,ii);
  %plot(dia,((fi(:,4:2:end,ii)-repmat(nominal(ii),[nmeas,6]))./repmat(nominal(ii),[nmeas,6])));
  mmplotyy(dia(:,1),fi(:,4:2:end,ii),temp);
  axis('tight');
  xlabel('Day')
end

legend(label_lamda);
 
mmplotyy('shrink');


fh=figure;
set(fh,'tag','FI_STATS');

for ii=1:6
  subplot(2,3,ii);
  boxplot(100*((fi(:,4:2:end,ii)-repmat(nominal(ii),[nmeas,6]))./repmat(nominal(ii),[nmeas,6])),...
          'label',label_lamda); 
  %    pos_ytext=get(gca,'YTick');
  %    pos_xtext=get(gca,'XTick');
  %set(gca,'FOntsize',8,'FontWeight','bold');
  xlabel('wavelength','FontSize',11,'FontWeight','bold')
  %if ii<5
      ylabel(sprintf('%s\n%s','%difference from ','nominal values'),'FontSize',11,'FontWeight','bold');
      title(sprintf('Filter #%d',ii-1),'FontSize',10,'FontWeight','bold');
      %text(pos_xtext(end-2),pos_ytext(1),sprintf('Filter #%d',ii-1),'FontSize',10,'FontWeight','bold');
      if ii==1
      ylabel('Intensity','FontSize',11,'FontWeight','bold');
      title('Intensity','FontWeight','bold');
      %text(pos_xtext(end-2),pos_ytext(1),'Filter #0','FontSize',10,'FontWeight','bold');
      end
  %else
  %    ylabel(sprintf('%s\n%s','%difference from ','nominal values'),'FontSize',11,'FontWeight','bold');
  %      text(pos_xtext(1),pos_ytext(1),sprintf('Filter #%d',ii-1),'FontSize',10,'FontWeight','bold');
  %end
end
sup=suptitle(sprintf('%s%s','Attenuation Filter Test, ',fioavg(regexp(fioavg,'AVG')-3:regexp(fioavg,'AVG')+6)));
pos=get(sup,'Position');
set(sup,'Handlevisibility','off','Position',[pos(1)+.02,pos(2)-.01,1]);
orient('landscape');
%
media=squeeze(fix(median(fi(:,4:2:end,2:end),1)));

med=[[0,fix(lamda/10)]',[f;media],];
a=mat2clip(med);

label_1={'FIOAVG ','slit #0','slit #1','slit #2','slit #3','slit #4','slit #5','mean'};
label_2={'filter #1','filter #2','filter #3','filter #4','filter #5'};

filter_table=[label_1',[label_2;num2cell(media);num2cell(fix(mean(media)))]];
makeHtmlTable([fix(media);fix(mean(media))],[],label_1,label_2 );



% ETC correction
% ETC(FILTER)= SUM  W(L)* AFC(L,F)
% AFC=  Attenuation Filter Correction 
% AFC(F,L)= NOMINAL(F)-REAL(F,L)

%AFC
O3W=[   0.00      0.00   -1.00    0.50    2.20   -1.70];
SO2W=[  0.00    -1.00    0.00    0.00    4.20   -3.20];



ETC_FILTER_CORRECTION=round(O3W*media);

%printmatrix(ETC_FILTER_CORRECTION)
table_filter_correction=[label_2;num2cell(round(ETC_FILTER_CORRECTION))];

makeHtmlTable(ETC_FILTER_CORRECTION,[],{'ETC FILTER CORR'},label_2 );

% media
%media;mat2clip(fix(mean(media)),'%5d')
f=figure;
set(f,'tag','FI wavelength');
r=matdiv(100*matadd(media,-mean(media)),media);

plot(lamda,r,'.:','Markersize',25);
hold on; plot(lamda,mean(r,2),'s:','Markersize',12);
legend('filter 1','filter 2','filter 3','filter 4','filter 5','mean',-1)

%l1=rline; set(findobj('Type','text'),'Visible','off'); set(l1,'Linewidth',1.5);
%set(l1(1),'Linewidth',5);
%set(findobj('Type','line'),'Handlevisibility','off')

set(gca,'XLim',[3020 3200],'FontSize',11,'FontWeight','bold');
ylabel('Differences to mean %','FontSize',12,'FontWeight','bold')
xlabel('wavelenght nm','FontSize',12,'FontWeight','bold')
sup=title({['Wavelength dependence of the attenuation filter,  #', brw_str],['ETC filter corr=[ ',num2str(ETC_FILTER_CORRECTION),']']});
pos=get(sup,'Position');
set(sup,'Position',[pos(1)-.03,pos(2)-.03,1],'FontSize',15);box off
legend('filter 1','filter 2','filter 3','filter 4','filter 5','mean',-1)
grid;

% ETC correction
% ETC(FILTER)= SUM  W(L)* AFC(L,F)
% AFC=  Attenuation Filter Co/home/aredondasrrection 
% AFC(F,L)= NOMINAL(F)-REAL(F,L)

%AFC
%O3W=[   0.00      0.00   -1.00    0.50    2.20   -1.70];
%SO2W=[  0.00    -1.00    0.00    0.00    4.20   -3.20];

%AFC=media-repmat(media(:,3),1,5);
%AFC=((media-repmat(mean(media),6,1)));
%AFC2=((media-repmat(nominal(2:end),6,1)));
%ETCF=O3W*AFC;
% ETC correction

%printmatrix(media,2);
%ETC_FILTER_CORRECTION=O3W*media;
%printmatrix(ETC_FILTER_CORRECTION);


##### SOURCE END #####
-->
   </body>
</html>