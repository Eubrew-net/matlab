
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
      <!--
This HTML is auto-generated from an M-file.
To make changes, update the M-file and republish this document.
      -->
      <title>dsp_report</title>
      <meta name="generator" content="MATLAB 7.8">
      <meta name="date" content="2009-09-23">
      <meta name="m-file" content="dsp_report"><style type="text/css">

body {
  background-color: white;
  margin:10px;
}

h1 {
  color: #990000; 
  font-size: x-large;
}

h2 {
  color: #990000;
  font-size: medium;
}

/* Make the text shrink to fit narrow windows, but not stretch too far in 
wide windows. */ 
p,h1,h2,div.content div {
  max-width: 600px;
  /* Hack for IE6 */
  width: auto !important; width: 600px;
}

pre.codeinput {
  background: #EEEEEE;
  padding: 10px;
}
@media print {
  pre.codeinput {word-wrap:break-word; width:100%;}
} 

span.keyword {color: #0000FF}
span.comment {color: #228B22}
span.string {color: #A020F0}
span.untermstring {color: #B20000}
span.syscmd {color: #B28C00}

pre.codeoutput {
  color: #666666;
  padding: 10px;
}

pre.error {
  color: red;
}

p.footer {
  text-align: right;
  font-size: xx-small;
  font-weight: lighter;
  font-style: italic;
  color: gray;
}

  </style></head>
   <body>
      <div class="content">
         <h2>Contents</h2>
         <div>
            <ul>
               <li><a href="#3">Ozone Dispersion analysis</a></li>
               <li><a href="#4">now calculate normaldsp</a></li>
               <li><a href="#5">Depuracion</a></li>
               <li><a href="#7">now calculate ozonecoeffs</a></li>
               <li><a href="#8">ozone vs UV comparison</a></li>
               <li><a href="#9">now do dispersion fit using Groebner analysis</a></li>
               <li><a href="#10">And now show difference between both methods for slits 1 and 5.</a></li>
               <li><a href="#12">Power fit vs Quadratic</a></li>
            </ul>
         </div><pre class="codeinput"><span class="keyword">function</span> [res,detail,DSP_QUAD,QUAD_SUM,QUAD_DETAIL,CUBIC_SUM,CUBIC_DETAIL,salida<span class="keyword">...</span>
    ]=dsp_report(day,year,brewnb,path,cfg,comment,uvr)
</pre><pre class="codeinput">day=day-1:day+1;
<span class="comment">%year=08;</span>
<span class="comment">%brewnb=193;</span>
Lines=1:14;
<span class="comment">%path='f:\red_brewer\brewer193\bdata193\193\dsp078\';</span>
<span class="comment">%comment='#193';</span>
<span class="comment">% polinomial order</span>
polynb=3;
<span class="comment">% ozone pos-&gt; from icf</span>
<span class="comment">% using read_icf= cfg(14)+cfg(44)</span>
<span class="comment">%cfg=read_icf('icf07808.193');</span>
ozonepos=cfg(14)+cfg(44);
</pre><pre class="codeoutput">Input argument "day" is undefined.

Error in ==&gt; dsp_report at 3
day=day-1:day+1;
</pre><h2>Ozone Dispersion analysis<a name="3"></a></h2><pre class="codeinput"><span class="comment">%function [wl,DSP,DSPstd,fwhm,fwhmstd,backlash,resup]=alldsp_(day,year,brew,lines,minslit,maxslit,usewl,dspp)</span>
h0=gcf;
[wl,dsp,dspstd,fwhm,fwhmstd,backlash]=alldsp_(day,year,brewnb,1:14,[],[],[],path);
dsp_orig=dsp;
wl_orig=wl;
 <span class="keyword">if</span> isempty(wl)
    <span class="keyword">return</span>;
 <span class="keyword">else</span>
    fplotdsp=sprintf(<span class="string">'lines_dsp_%03d%02d_%s%03d'</span>,day(1),year,<span class="string">'_'</span>,brewnb);
    h1=gcf;
    <span class="keyword">for</span> i=h0:h1
       figure(i)
       set(i,<span class="string">'Tag'</span>,[<span class="string">'DSP_LINES_'</span>,num2str(i)]);
    <span class="keyword">end</span>
    <span class="comment">%printfigures(h0,h1,[fplotdsp]);</span>
    <span class="comment">%close all</span>
<span class="keyword">end</span>






fnamealldsp=sprintf(<span class="string">'alldsp_%03d%02d_%s.%03d'</span>,day(1),year,comment,brewnb);
disp(sprintf(<span class="string">'saving alldsp to %s'</span>,[path fnamealldsp]));

<span class="comment">%Bewer ozone lines</span>
  jl=find(wl&lt;3500);
  jnul=find(wl&gt;wl(max(jl)))
  dsp(jnul,:)=[];
  wl(jnul,:)=[];
  dspstd(jnul,:)=[];
  fwhm(jnul,:)=[]
  fwhmstd(jnul,:)=[]
  backlash(jnul,:)=[]

dsp_orig=dsp;
wl_orig=wl;

  fnamealldsp=sprintf(<span class="string">'ozonedsp_%03d%02d_%s.%03d'</span>,day(1),year,comment,brewnb);
  save([path fnamealldsp],<span class="string">'wl'</span>,<span class="string">'dsp'</span>,<span class="string">'dspstd'</span>,<span class="string">'fwhm'</span>,<span class="string">'fwhmstd'</span>,<span class="string">'backlash'</span>);

  <span class="comment">%h1=gcf;</span>
  <span class="comment">%fplotdsp=sprintf('alldsp_%03d%02d_%s%03d',day(1),year,comment,brewnb);</span>
  <span class="comment">%printfigures(h0,h1,[fplotdsp]);</span>
  <span class="comment">%close all</span>
</pre><h2>now calculate normaldsp<a name="4"></a></h2>
         <p>for ozone only use wv &lt;3340</p><pre class="codeinput"><span class="comment">%j=find(wl&lt;3400);</span>

[fwl,fstps,pwl,pstps]=normaldsp(wl,dsp);  <span class="comment">% quad for every slit</span>
fnameN=sprintf(<span class="string">'dspnorm_%03d%02d_%s.%03d'</span>,day(1),year,comment,brewnb);
</pre><h2>Depuracion<a name="5"></a></h2>
         <p>si el residuo es mayor que 0.1 y hay mas de tres lineas por slit se elimina</p><pre class="codeinput">jbad=[];
lamda_nominal=[3032.06 3063.01 3100.53 3135.07 3168.09 3199.98];
flag_reprocess=0;
<span class="keyword">for</span> j=1:5
 <span class="keyword">for</span> i=1:6 <span class="comment">%slit</span>

    jbad=[];
    fwll=fwl(:,i);
    len=size(find(fwll),1);
    <span class="keyword">if</span> j==1     jbad=find(abs(fwll)&gt;0.15);
    <span class="keyword">else</span> jbad=find(abs(fwll)&gt;0.12);
    <span class="keyword">end</span>

    <span class="keyword">if</span> ~isempty(jbad)
    <span class="comment">%ordenamos por el mayor residuo</span>
    <span class="comment">%[a,b]=sort(abs(fwll(jbad)),'descend');</span>
    <span class="comment">%ordenamos por el mayor alejamiento de la nominal</span>
    [a,b]=sort(abs(wl(jbad)-lamda_nominal(2)),<span class="string">'descend'</span>);
    jbad=jbad(b);

         <span class="keyword">for</span> ii=1:length(jbad)
             <span class="keyword">if</span> len&gt;3
               dsp(jbad(ii),i)=0;
               disp(sprintf(<span class="string">'eliminamos la linea slit %d %f %f'</span>,i,wl(jbad(ii)),fwll(jbad(ii))));
               flag_reprocess=1;
               len=len-1;
               <span class="keyword">if</span> flag_reprocess
                  [fwl,fstps,pwl,pstps]=normaldsp(wl,dsp);  <span class="comment">% quad for every slit</span>
                  i=i-1;
                  <span class="comment">%if i==0 i=1; end</span>
                  <span class="keyword">break</span>;
               <span class="keyword">end</span>
             <span class="keyword">else</span>
                warning(<span class="string">'not enough lines if remove'</span>);
             <span class="keyword">end</span>
         <span class="keyword">end</span>
      <span class="keyword">end</span>

<span class="keyword">if</span> flag_reprocess
 [fwl,fstps,pwl,pstps]=normaldsp(wl,dsp);  <span class="comment">% quad for every slit</span>
 fnameN=sprintf(<span class="string">'dspnorm_%03d%02d_%s.%03d'</span>,day(1),year,comment,brewnb);


<span class="keyword">end</span>
<span class="keyword">end</span>
<span class="keyword">end</span>
<span class="keyword">if</span> flag_reprocess
 [fwl,fstps,pwl,pstps]=normaldsp(wl,dsp);  <span class="comment">% quad for every slit</span>
 fnameN=sprintf(<span class="string">'dspnorm_%03d%02d_%s.%03d'</span>,day(1),year,comment,brewnb);
 figure;plot(wl,fwl,<span class="string">'o-'</span>);
 fnamealldsp=sprintf(<span class="string">'ozonedsp_%03d%02d_%s.%03d'</span>,day(1),year,comment,brewnb);
 save([path fnamealldsp],<span class="string">'wl'</span>,<span class="string">'dsp'</span>,<span class="string">'dspstd'</span>,<span class="string">'fwhm'</span>,<span class="string">'fwhmstd'</span>,<span class="string">'backlash'</span>);


<span class="keyword">end</span>
</pre><pre class="codeinput">lamda_nominal=[3032.06 3063.01 3100.53 3135.07 3168.09 3199.98];
disp_lines=[
2893.600  1 1<span class="comment">%  hg  9</span>
2967.280  3 1<span class="comment">%  Hg  12</span>
3018.360	4	3<span class="comment">%	Zn	1</span>
3035.780	5	3<span class="comment">%	Zn	2</span>
3133.167	7	2<span class="comment">%	Cd	4</span>
3261.055	8	2<span class="comment">%	Cd	5</span>
3282.330	9	3<span class="comment">%	Zn	3</span>
3341.480	10	1<span class="comment">%	Hg	13</span>
3403.652	11	2<span class="comment">%	Cd	6</span>
3499.950	12	2<span class="comment">%	Cd	7</span>
3611.630	13	2<span class="comment">%	Cd	8</span>
];
lamp_name=[  <span class="string">'Hg'</span>;<span class="string">'Hg'</span>;<span class="string">'Zn'</span>;<span class="string">'Zn'</span>;<span class="string">'Cd'</span>;<span class="keyword">...</span>
            <span class="string">'Cd'</span> ;<span class="string">'Zn'</span>;<span class="string">'Hg'</span>;<span class="string">'Cd'</span>;<span class="string">'Cd'</span>;<span class="string">'Cd'</span>];
lamp_name=cellstr(lamp_name);

f3=figure;  set(f3,<span class="string">'tag'</span>,<span class="string">'DSP_QUAD_RES'</span>);
plot(wl,fwl,<span class="string">'o-'</span>);
set(gca,<span class="string">'Xlim'</span>,[2850,3450],<span class="string">'LineWidth'</span>,1);
title(sprintf(<span class="string">'%s%s\ndspnorm%c%03d%02d%c%s.%03d'</span>,<span class="string">'Normaldsp, '</span>,datestr(now,29),<span class="string">'-'</span>,day(1),year,<span class="string">'-'</span>,comment,brewnb),<span class="string">'FontWeight'</span>,<span class="string">'normal'</span>);
ylabel(<span class="string">'Residuals [A]'</span>);  xlabel(<span class="string">'wavelength [A]'</span>);
legend(<span class="string">'slit #0'</span>,<span class="string">'slit #1'</span>,<span class="string">'slit #2'</span>,<span class="string">'slit #3'</span>,<span class="string">'slit #4'</span>,<span class="string">'slit #5'</span>,<span class="string">'Location'</span>,<span class="string">'SouthEast'</span>);
hl=hline([-0.1,0.1],<span class="string">'r-'</span>); vl=vline(disp_lines(:,1:2),<span class="string">'k-.'</span>,lamp_name);
disp(sprintf(<span class="string">'saving normaldsp to %s as brewer compatible file'</span>,[path fnameN]));
orient(<span class="string">'portrait'</span>);

<span class="comment">%f1=figure;</span>
<span class="comment">%set(f1,'Tag','DSP')</span>
<span class="comment">%plot(wl(j),fwl,'o-');</span>
<span class="comment">%title(['Normaldsp ' path fnameN '-' datestr(now)]);</span>
<span class="comment">%ylabel('Residuals [&iuml;&iquest;&frac12;]');</span>
<span class="comment">%xlabel('wavelength [&iuml;&iquest;&frac12;]');</span>
<span class="comment">%legend('slit #0','slit #1','slit #2','slit #3','slit #4','slit #5');</span>


disp(sprintf(<span class="string">'saving normaldsp to %s as brewer compatible file'</span>,[path fnameN]));

<span class="comment">%save([path fnameN],'pwl','pstps');</span>
data=pwl(:,end:-1:1)';
mydata=data(:);
savefmt([path fnameN],[mydata(4:end);mydata(1:3)],<span class="string">''</span>,<span class="string">'%.7e'</span>);
DSP_QUAD=[mydata(4:end);mydata(1:3)];
disp(<span class="string">'Use polyval(pwl(2,:),wl) for calculating normal wavelengths'</span>)
</pre><h2>now calculate ozonecoeffs<a name="7"></a></h2><pre class="codeinput">outfname_cuadratic=sprintf(<span class="string">'opos%03d%02d_%s.%03d'</span>,day(1),year,comment,brewnb);
disp(sprintf(<span class="string">'Saving ozonecoeffs to %s'</span>,[path outfname_cuadratic]));

salida=[path outfname_cuadratic];
<span class="comment">% ozonepos is total steps from uvzero. #mircometer zero + ozone position</span>
<span class="comment">% dcfname is dcfile name for brstps.</span>
<span class="comment">% fname is data from alldsp</span>
<span class="comment">% dcfname is file ontained from savedsp</span>
<span class="comment">% outfname is were log should be written</span>

<span class="comment">% ozone pos-&gt; from icf</span>
<span class="comment">% using read_icf= cfg(14)+cfg(44)</span>
<span class="comment">%cfg=read_icf('icf07808.193');</span>
<span class="comment">%ozonepos=cfg(14)+cfg(44);</span>
CALC_STEP=cfg(14);
[res,detail,salida]=ozonecoeff3([path fnamealldsp],[ozonepos,cfg(44)],[path fnameN],[path outfname_cuadratic]);

jcal=find((res(:,1)==CALC_STEP),1);
jumk=find((res(:,1)==CALC_STEP),1,<span class="string">'last'</span>);
</pre><h2>ozone vs UV comparison<a name="8"></a></h2><pre class="codeinput">disp(<span class="string">'holo'</span>);

<span class="comment">% Sun Scan simulation</span>
<span class="comment">% asuming mo3=mRay=2 and o3=300UD ct during sc</span>
<span class="comment">%Fi=300*res(:,2)*2-res(:,end);</span>
<span class="comment">%o3sc=( Fi+res(16,end))/(2*res(16,2));</span>
</pre><h2>now do dispersion fit using Groebner analysis<a name="9"></a></h2><pre class="codeinput">  dsp=dsp_orig;
  wl=wl_orig;

dsp(~dsp)=NaN;
nslit=min(sum(~isnan(dsp)));
<span class="keyword">if</span> nslit&lt;=polynb
   polynb=nslit-1;
<span class="keyword">end</span>
dsp(isnan(dsp))=0
fname7=sprintf(<span class="string">'dsp_%03d%02d_%s.%03d'</span>,day(1),year,comment,brewnb);
disp(sprintf(<span class="string">'saving powfiu7 to %s'</span>,[path fname7]));
pos0=powfiu7;
<span class="keyword">if</span> nanmean(fwhm(fwhm(:,1)~=0,1))&lt;65,pos0=powfiu7(1);<span class="keyword">end</span>
[fstd,slitpos,rmsf]=powfiu7(pos0,wl,dsp,polynb,[],[],[],[path fname7]);
disp(<span class="string">'Residuals using powfiu7 [RMS]:'</span>);
disp(rmsf);

<span class="comment">% check slitpos residuals.</span>

dsl=slitpos(end,:)-pos0;
<span class="keyword">if</span> any(abs(dsl)&gt;0.05),  <span class="comment">% do again with this one slit corrected</span>
 ind=find(dsl==max(dsl));
 pos0(ind)=pos0(ind)+dsl(ind);<span class="comment">% shift slitpos and recalculate</span>
 disp(sprintf(<span class="string">'Too large slitpos deviation: Recalc with slit #%d shifted by %.3f'</span>,ind,dsl(ind)));
 [fstd,slitpos,rmsf]=powfiu7(pos0,wl,dsp,polynb,[],[],[],[path fname7]);
 disp(<span class="string">'Residuals using powfiu7 [RMS]:'</span>);
disp( rmsf);
<span class="keyword">end</span>


ind=fstd==0;fstd(ind)=nan;
<span class="comment">%figure;plot(wl,fstd(:,:,end)/10,'o-');</span>
<span class="comment">%f2=figure;</span>
<span class="comment">%set(f2,'Tag','DSP')</span>
<span class="comment">%plot(wl,fstd(:,:,end),'o-');</span>
<span class="comment">%title(['Powfiu7 RMS=' sprintf('%.4f',(min(rmsf/10))) ' ' fname7 '-' datestr(now)]);</span>
<span class="comment">%ylabel('Residuals  [&iuml;&iquest;&frac12;]');</span>
<span class="comment">%xlabel('wavelength [&iuml;&iquest;&frac12;]');</span>
<span class="comment">%legend('slit #0','slit #1','slit #2','slit #3','slit #4','slit #5');</span>
f2=figure;plot(wl,fstd(:,:,end),<span class="string">'o-'</span>); set(gca,<span class="string">'FontSize'</span>,11,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>)
title(sprintf(<span class="string">'%s%.4f \ndsp%c%03d%02d%c%s.%03d%s%s'</span>,<span class="string">'Powfiu7 RMS='</span>,<span class="keyword">...</span>
               min(rmsf/10),<span class="string">'-'</span>,day(1),year,<span class="string">'-'</span>,comment,brewnb,<span class="string">'  '</span>,datestr(now,29)),<span class="keyword">...</span>
              <span class="string">'FontSize'</span>,15,<span class="string">'FontWeight'</span>,<span class="string">'normal'</span>);
ylabel(<span class="string">'Residuals  [A]'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
xlabel(<span class="string">'wavelength [A]'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
legend(<span class="string">'slit #0'</span>,<span class="string">'slit #1'</span>,<span class="string">'slit #2'</span>,<span class="string">'slit #3'</span>,<span class="string">'slit #4'</span>,<span class="string">'slit #5'</span>,<span class="string">'Location'</span>,<span class="string">'SouthEast'</span>);
hl=hline([-0.1,0.1]); set(hl,<span class="string">'Linewidth'</span>,2,<span class="string">'color'</span>,<span class="string">'r'</span>)
vl=vline(disp_lines(:,1:2),<span class="string">'y:'</span>,lamp_name); set(vl,<span class="string">'Linewidth'</span>,2);
<span class="comment">%vlabel=findobj('color','y'); set(vlabel,'color','k','Fontweight','bold')</span>
set(f2,<span class="string">'tag'</span>,<span class="string">'DSP_CUBIC_RES'</span>);
set(gca,<span class="string">'Xlim'</span>,[2850,3450]);


disp(<span class="string">'Use brstps2 to calculate steps and wavelengths'</span>);
</pre><h2>And now show difference between both methods for slits 1 and 5.<a name="10"></a></h2><pre class="codeinput">testwl1=3000:10:3500;
testwl5=3500:10:3650;
stps17=brstps2(testwl1,1,[],[path fname7]);  <span class="comment">% reference steps to use</span>
stps57=brstps2(testwl5,5,[],[path fname7]);

<span class="comment">%quad1=polyval(pwl(2,:),stps17);</span>
<span class="comment">%quad5=polyval(pwl(6,:),stps57);</span>

<span class="keyword">for</span> i=1:6
 stps(i,:)=brstps2(testwl1,i-1,[],[path fname7])';  <span class="comment">% reference steps to use</span>
 quad1(i,:)=polyval(pwl(i,:),stps(i,:)')';
<span class="keyword">end</span>

f1=figure;
plot(testwl1,matadd(quad1,-testwl1)),<span class="comment">%testwl5,quad5-testwl5);</span>
legend(<span class="string">'slit #0'</span>,<span class="string">'slit #1'</span>,<span class="string">'slit #2'</span>,<span class="string">'slit #3'</span>,<span class="string">'slit #4'</span>,<span class="string">'slit #5'</span>);
hline([-0.1,0.1])
title(<span class="string">'Normaldsp versus powfiu7 using slit 1 (3000:3500) and 5 (3500:3650)'</span>)
ylabel(<span class="string">'Quad - Cubic  [A]'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
xlabel(<span class="string">'wavelength [A]'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
set(f1,<span class="string">'tag'</span>,<span class="string">'DSP_QUAD_CUBIC'</span>);
set(gca,<span class="string">'Xlim'</span>,[2850,3450]);



<span class="comment">%f3=figure;</span>
<span class="comment">%set(f3,'Tag','DSP')</span>
<span class="comment">%plot(testwl1,quad1-testwl1);%,testwl5,quad5-testwl5);</span>
<span class="comment">%title('Normaldsp versus powfiu7 using slit 1 (3000:3500) and 5 (3500:3650)')</span>
<span class="comment">%ylabel('normaldsp-powfiu7 [&iuml;&iquest;&frac12;]');</span>
<span class="comment">%hline([-0.1,0.1]);</span>
</pre><pre class="codeinput">outfname_cubic=sprintf(<span class="string">'opos_pow7_%03d%02d_%s.%03d'</span>,day(1),year,comment,brewnb);
disp(sprintf(<span class="string">'Saving ozonecoeffs to %s'</span>,[path outfname_cubic]));


<span class="comment">% ozonepos is total steps from uvzero. #mircometer zero + ozone position</span>
<span class="comment">% dcfname is dcfile name for brstps.</span>
<span class="comment">% fname is data from alldsp</span>
<span class="comment">% dcfname is file ontained from savedsp</span>
<span class="comment">% outfname is were log should be written</span>

<span class="comment">% ozone pos-&gt; from icf</span>
<span class="comment">% using read_icf= cfg(14)+cfg(44)</span>
<span class="comment">%cfg=read_icf('icf07808.193');</span>
<span class="comment">%ozonepos=cfg(14)+cfg(44);</span>

[res2,detail2]=ozonecoeff3([path fnamealldsp],[ozonepos,cfg(44)],[path fname7],[path outfname_cubic]);
</pre><h2>Power fit vs Quadratic<a name="12"></a></h2><pre class="codeinput">jcal=find(res(:,1)==cfg(14),1,<span class="string">'first'</span>);
disp(<span class="string">'Quadratic'</span>)
<span class="comment">%quad_dsp_coef=printmatrix(res(j,:),4);</span>
 QUAD_SUM=printmatrix(res(jcal,:),4);
 QUAD_DETAIL=printmatrix(detail(:,:,jcal),4);

<span class="comment">%disp('Cubic')</span>
<span class="comment">%cubic_dsp_coef=printmatrix(res2(j,:),4);</span>
disp(<span class="string">'Cubic'</span>)
CUBIC_SUM=printmatrix(res2(jcal,:),4);
disp(<span class="string">'Cubic'</span>)

<span class="keyword">for</span> ii=-1:1
CUBIC_DETAIL{ii+2}=printmatrix(detail2(:,:,jcal+ii),4);
<span class="keyword">end</span>

label_1={<span class="string">'slit #0'</span>,<span class="string">'slit #1'</span>,<span class="string">'slit #2'</span>,<span class="string">'slit #3'</span>,<span class="string">'slit #4'</span>,<span class="string">'slit #5'</span>};
label_2={sprintf(<span class="string">'step= %d '</span>,res(jcal,1));<span class="string">'WL(A)'</span>;<span class="string">'Res(A)'</span>;<span class="string">'O3abs(1/cm)'</span>;<span class="string">'Ray abs(1/cm)'</span>;<span class="string">'SO2abs(1/cm)'</span>};
label_r={<span class="string">'step  '</span>,<span class="string">'O3abs  '</span>,<span class="string">'Rayabs  '</span>,<span class="string">'SO2abs  '</span>,<span class="string">'O3SO2Abs'</span>};
quad_report=num2cell(res(jcal,1:end-2));
quad_report=[label_r;quad_report]


QUAD_DETAIL=[]; temp_res=[<span class="string">' '</span>,label_r,<span class="string">' '</span>];
<span class="keyword">for</span> ii=-1:1
label_1={<span class="string">'slit\#0'</span>,<span class="string">'slit\#1'</span>,<span class="string">'slit\#2'</span>,<span class="string">'slit\#3'</span>,<span class="string">'slit\#4'</span>,<span class="string">'slit\#5'</span>};
label_2={sprintf(<span class="string">'step= %d '</span>,res(jcal+ii,1));<span class="string">'WL(A)'</span>;<span class="string">'Res(A)'</span>;<span class="string">'O3abs(1/cm)'</span>;<span class="string">'Ray abs(1/cm)'</span>;<span class="string">'SO2abs(1/cm)'</span>};
label_r={<span class="string">'step'</span>,<span class="string">'O3abs'</span>,<span class="string">'Rayabs'</span>,<span class="string">'SO2abs'</span>,<span class="string">'O3SO2Abs'</span>};

 detail(1,:,jcal+ii)=round(detail(1,:,jcal+ii));
 step_report=num2cell(detail(1:end-1,:,jcal+ii));
 <span class="comment">%  end -2 introducimos daumont</span>
 quad_res=num2cell(res(jcal+ii,1:end-2));
 step_report=[label_2,[label_1;step_report]]
 QUAD_DETAIL=[QUAD_DETAIL;step_report]
 temp_res=[temp_res;[<span class="string">' '</span>,quad_res,<span class="string">' '</span>]];
<span class="keyword">end</span>
QUAD_DETAIL=[QUAD_DETAIL;temp_res];


disp(<span class="string">'Quadratic'</span>)
quad_dsp_res=printmatrix(detail(:,:,jcal),4);
disp(<span class="string">'Cubic'</span>)
cubic_dsp_coef=printmatrix(detail2(:,:,jcal),4);



f4=figure;
set(f4,<span class="string">'Tag'</span>,<span class="string">'DSP'</span>);
<span class="comment">% res(1,end-1) los dos ulitimos son el umkher</span>

limits=round([min(res(1:end-2,2))-0.01,max(res2(1:end-2,2))+0.01]*100)/100;
<span class="comment">%mmplotyy(res(:,1),res(:,2),limits,res2(:,2),limits);</span>
mmplotyy(res(1:end-2,1),[res(1:end-2,2),res2(1:end-2,2)],limits,[gradient(res(1:end-2,2)),gradient(res2(1:end-2,2))]);
mmplotyy(<span class="string">'gradient'</span>);
hold <span class="string">on</span>
<span class="comment">%mmplotyy(res(:,1),res(:,2),limits,res2(:,2),limits);</span>
xlabel(<span class="string">'Calc Step'</span>);
title([<span class="string">'Ozone Absortion Coefficient  #'</span>, num2str(brewnb)]);
legend(<span class="string">'Quadratic'</span>,<span class="string">'Cubic'</span>);


<span class="comment">%res=cat(3,res(jcal-2:jcal+2,:),res2(jcal-2:jcal+2,:));</span>
res=cat(3,[res(jcal-2:jcal+2,:);res(end-1:end,:)],[res2(jcal-2:jcal+2,:);res2(end-1:end,:)]);
detail=cat(4,detail(:,:,[jcal-2:jcal+2,end-1:end]),detail(:,:,[jcal-2:jcal+2,end-1:end]));
</pre><p class="footer"><br>
            Published with MATLAB&reg; 7.8<br></p>
      </div>
      <!--
##### SOURCE BEGIN #####
function [res,detail,DSP_QUAD,QUAD_SUM,QUAD_DETAIL,CUBIC_SUM,CUBIC_DETAIL,salida...
    ]=dsp_report(day,year,brewnb,path,cfg,comment,uvr)
day=day-1:day+1;
%year=08;
%brewnb=193;
Lines=1:14;
%path='f:\red_brewer\brewer193\bdata193\193\dsp078\';
%comment='#193';
% polinomial order
polynb=3;
% ozone pos-> from icf
% using read_icf= cfg(14)+cfg(44)
%cfg=read_icf('icf07808.193');
ozonepos=cfg(14)+cfg(44);


%% Ozone Dispersion analysis
%function [wl,DSP,DSPstd,fwhm,fwhmstd,backlash,resup]=alldsp_(day,year,brew,lines,minslit,maxslit,usewl,dspp)
h0=gcf;
[wl,dsp,dspstd,fwhm,fwhmstd,backlash]=alldsp_(day,year,brewnb,1:14,[],[],[],path);
dsp_orig=dsp;
wl_orig=wl;
 if isempty(wl)
    return;
 else
    fplotdsp=sprintf('lines_dsp_%03d%02d_%s%03d',day(1),year,'_',brewnb);
    h1=gcf;
    for i=h0:h1
       figure(i)
       set(i,'Tag',['DSP_LINES_',num2str(i)]);
    end
    %printfigures(h0,h1,[fplotdsp]);
    %close all
end






fnamealldsp=sprintf('alldsp_%03d%02d_%s.%03d',day(1),year,comment,brewnb);
disp(sprintf('saving alldsp to %s',[path fnamealldsp]));

%Bewer ozone lines
  jl=find(wl<3500);
  jnul=find(wl>wl(max(jl)))
  dsp(jnul,:)=[];
  wl(jnul,:)=[];
  dspstd(jnul,:)=[];
  fwhm(jnul,:)=[]
  fwhmstd(jnul,:)=[]
  backlash(jnul,:)=[]

dsp_orig=dsp;
wl_orig=wl;
  
  fnamealldsp=sprintf('ozonedsp_%03d%02d_%s.%03d',day(1),year,comment,brewnb);
  save([path fnamealldsp],'wl','dsp','dspstd','fwhm','fwhmstd','backlash');

  %h1=gcf;
  %fplotdsp=sprintf('alldsp_%03d%02d_%s%03d',day(1),year,comment,brewnb);
  %printfigures(h0,h1,[fplotdsp]);
  %close all


%% now calculate normaldsp
% for ozone only use wv <3340
%j=find(wl<3400);

[fwl,fstps,pwl,pstps]=normaldsp(wl,dsp);  % quad for every slit
fnameN=sprintf('dspnorm_%03d%02d_%s.%03d',day(1),year,comment,brewnb);


%% Depuracion
% si el residuo es mayor que 0.1 y hay mas de tres lineas por slit se
% elimina
jbad=[];
lamda_nominal=[3032.06 3063.01 3100.53 3135.07 3168.09 3199.98];
flag_reprocess=0;
for j=1:5
 for i=1:6 %slit 

    jbad=[];
    fwll=fwl(:,i);
    len=size(find(fwll),1);
    if j==1     jbad=find(abs(fwll)>0.15);
    else jbad=find(abs(fwll)>0.12);
    end
    
    if ~isempty(jbad)
    %ordenamos por el mayor residuo
    %[a,b]=sort(abs(fwll(jbad)),'descend');
    %ordenamos por el mayor alejamiento de la nominal
    [a,b]=sort(abs(wl(jbad)-lamda_nominal(2)),'descend');
    jbad=jbad(b);
      
         for ii=1:length(jbad) 
             if len>3
               dsp(jbad(ii),i)=0;
               disp(sprintf('eliminamos la linea slit %d %f %f',i,wl(jbad(ii)),fwll(jbad(ii))));
               flag_reprocess=1;
               len=len-1;
               if flag_reprocess
                  [fwl,fstps,pwl,pstps]=normaldsp(wl,dsp);  % quad for every slit
                  i=i-1;
                  %if i==0 i=1; end
                  break;
               end
             else
                warning('not enough lines if remove');
             end
         end
      end

if flag_reprocess
 [fwl,fstps,pwl,pstps]=normaldsp(wl,dsp);  % quad for every slit
 fnameN=sprintf('dspnorm_%03d%02d_%s.%03d',day(1),year,comment,brewnb);
 
 
end      
end
end
if flag_reprocess
 [fwl,fstps,pwl,pstps]=normaldsp(wl,dsp);  % quad for every slit
 fnameN=sprintf('dspnorm_%03d%02d_%s.%03d',day(1),year,comment,brewnb);
 figure;plot(wl,fwl,'o-');
 fnamealldsp=sprintf('ozonedsp_%03d%02d_%s.%03d',day(1),year,comment,brewnb);
 save([path fnamealldsp],'wl','dsp','dspstd','fwhm','fwhmstd','backlash');

 
end      
%%
lamda_nominal=[3032.06 3063.01 3100.53 3135.07 3168.09 3199.98];
disp_lines=[
2893.600  1 1%  hg  9
2967.280  3 1%  Hg  12
3018.360	4	3%	Zn	1
3035.780	5	3%	Zn	2
3133.167	7	2%	Cd	4
3261.055	8	2%	Cd	5
3282.330	9	3%	Zn	3
3341.480	10	1%	Hg	13
3403.652	11	2%	Cd	6
3499.950	12	2%	Cd	7
3611.630	13	2%	Cd	8
];
lamp_name=[  'Hg';'Hg';'Zn';'Zn';'Cd';...
            'Cd' ;'Zn';'Hg';'Cd';'Cd';'Cd'];
lamp_name=cellstr(lamp_name);

f3=figure;  set(f3,'tag','DSP_QUAD_RES');
plot(wl,fwl,'o-');
set(gca,'Xlim',[2850,3450],'LineWidth',1);
title(sprintf('%s%s\ndspnorm%c%03d%02d%c%s.%03d','Normaldsp, ',datestr(now,29),'-',day(1),year,'-',comment,brewnb),'FontWeight','normal');
ylabel('Residuals [A]');  xlabel('wavelength [A]');
legend('slit #0','slit #1','slit #2','slit #3','slit #4','slit #5','Location','SouthEast');
hl=hline([-0.1,0.1],'r-'); vl=vline(disp_lines(:,1:2),'k-.',lamp_name); 
disp(sprintf('saving normaldsp to %s as brewer compatible file',[path fnameN]));
orient('portrait');  

%f1=figure;
%set(f1,'Tag','DSP')
%plot(wl(j),fwl,'o-');
%title(['Normaldsp ' path fnameN '-' datestr(now)]);
%ylabel('Residuals [ï¿½]');
%xlabel('wavelength [ï¿½]');
%legend('slit #0','slit #1','slit #2','slit #3','slit #4','slit #5');


disp(sprintf('saving normaldsp to %s as brewer compatible file',[path fnameN]));

%save([path fnameN],'pwl','pstps');
data=pwl(:,end:-1:1)';
mydata=data(:);
savefmt([path fnameN],[mydata(4:end);mydata(1:3)],'','%.7e');
DSP_QUAD=[mydata(4:end);mydata(1:3)];
disp('Use polyval(pwl(2,:),wl) for calculating normal wavelengths')

%% now calculate ozonecoeffs

outfname_cuadratic=sprintf('opos%03d%02d_%s.%03d',day(1),year,comment,brewnb);
disp(sprintf('Saving ozonecoeffs to %s',[path outfname_cuadratic]));

salida=[path outfname_cuadratic];
% ozonepos is total steps from uvzero. #mircometer zero + ozone position
% dcfname is dcfile name for brstps.
% fname is data from alldsp
% dcfname is file ontained from savedsp
% outfname is were log should be written

% ozone pos-> from icf
% using read_icf= cfg(14)+cfg(44)
%cfg=read_icf('icf07808.193');
%ozonepos=cfg(14)+cfg(44);
CALC_STEP=cfg(14);
[res,detail,salida]=ozonecoeff3([path fnamealldsp],[ozonepos,cfg(44)],[path fnameN],[path outfname_cuadratic]);

jcal=find((res(:,1)==CALC_STEP),1);
jumk=find((res(:,1)==CALC_STEP),1,'last');


%% ozone vs UV comparison

disp('holo');

% Sun Scan simulation
% asuming mo3=mRay=2 and o3=300UD ct during sc
%Fi=300*res(:,2)*2-res(:,end);
%o3sc=( Fi+res(16,end))/(2*res(16,2));


%% now do dispersion fit using Groebner analysis
  dsp=dsp_orig;
  wl=wl_orig;

dsp(~dsp)=NaN;
nslit=min(sum(~isnan(dsp)));
if nslit<=polynb
   polynb=nslit-1;
end
dsp(isnan(dsp))=0
fname7=sprintf('dsp_%03d%02d_%s.%03d',day(1),year,comment,brewnb);
disp(sprintf('saving powfiu7 to %s',[path fname7]));
pos0=powfiu7;
if nanmean(fwhm(fwhm(:,1)~=0,1))<65,pos0=powfiu7(1);end
[fstd,slitpos,rmsf]=powfiu7(pos0,wl,dsp,polynb,[],[],[],[path fname7]);
disp('Residuals using powfiu7 [RMS]:');
disp(rmsf);

% check slitpos residuals.

dsl=slitpos(end,:)-pos0;
if any(abs(dsl)>0.05),  % do again with this one slit corrected
 ind=find(dsl==max(dsl));
 pos0(ind)=pos0(ind)+dsl(ind);% shift slitpos and recalculate
 disp(sprintf('Too large slitpos deviation: Recalc with slit #%d shifted by %.3f',ind,dsl(ind)));
 [fstd,slitpos,rmsf]=powfiu7(pos0,wl,dsp,polynb,[],[],[],[path fname7]);
 disp('Residuals using powfiu7 [RMS]:');
disp( rmsf);
end


ind=fstd==0;fstd(ind)=nan;
%figure;plot(wl,fstd(:,:,end)/10,'o-');
%f2=figure;
%set(f2,'Tag','DSP')
%plot(wl,fstd(:,:,end),'o-');
%title(['Powfiu7 RMS=' sprintf('%.4f',(min(rmsf/10))) ' ' fname7 '-' datestr(now)]);
%ylabel('Residuals  [ï¿½]');
%xlabel('wavelength [ï¿½]');
%legend('slit #0','slit #1','slit #2','slit #3','slit #4','slit #5');
f2=figure;plot(wl,fstd(:,:,end),'o-'); set(gca,'FontSize',11,'FontWeight','bold')
title(sprintf('%s%.4f \ndsp%c%03d%02d%c%s.%03d%s%s','Powfiu7 RMS=',...
               min(rmsf/10),'-',day(1),year,'-',comment,brewnb,'  ',datestr(now,29)),...
              'FontSize',15,'FontWeight','normal');
ylabel('Residuals  [A]','FontSize',12,'FontWeight','bold');
xlabel('wavelength [A]','FontSize',12,'FontWeight','bold');
legend('slit #0','slit #1','slit #2','slit #3','slit #4','slit #5','Location','SouthEast');
hl=hline([-0.1,0.1]); set(hl,'Linewidth',2,'color','r')
vl=vline(disp_lines(:,1:2),'y:',lamp_name); set(vl,'Linewidth',2);
%vlabel=findobj('color','y'); set(vlabel,'color','k','Fontweight','bold')
set(f2,'tag','DSP_CUBIC_RES');
set(gca,'Xlim',[2850,3450]);


disp('Use brstps2 to calculate steps and wavelengths');

%% And now show difference between both methods for slits 1 and 5.

testwl1=3000:10:3500;
testwl5=3500:10:3650;
stps17=brstps2(testwl1,1,[],[path fname7]);  % reference steps to use
stps57=brstps2(testwl5,5,[],[path fname7]);

%quad1=polyval(pwl(2,:),stps17);
%quad5=polyval(pwl(6,:),stps57);

for i=1:6
 stps(i,:)=brstps2(testwl1,i-1,[],[path fname7])';  % reference steps to use
 quad1(i,:)=polyval(pwl(i,:),stps(i,:)')';
end

f1=figure;
plot(testwl1,matadd(quad1,-testwl1)),%testwl5,quad5-testwl5);
legend('slit #0','slit #1','slit #2','slit #3','slit #4','slit #5');
hline([-0.1,0.1])
title('Normaldsp versus powfiu7 using slit 1 (3000:3500) and 5 (3500:3650)')
ylabel('Quad - Cubic  [A]','FontSize',12,'FontWeight','bold');
xlabel('wavelength [A]','FontSize',12,'FontWeight','bold');
set(f1,'tag','DSP_QUAD_CUBIC');
set(gca,'Xlim',[2850,3450]);



%f3=figure;
%set(f3,'Tag','DSP')
%plot(testwl1,quad1-testwl1);%,testwl5,quad5-testwl5);
%title('Normaldsp versus powfiu7 using slit 1 (3000:3500) and 5 (3500:3650)')
%ylabel('normaldsp-powfiu7 [ï¿½]');
%hline([-0.1,0.1]);



%%
outfname_cubic=sprintf('opos_pow7_%03d%02d_%s.%03d',day(1),year,comment,brewnb);
disp(sprintf('Saving ozonecoeffs to %s',[path outfname_cubic]));


% ozonepos is total steps from uvzero. #mircometer zero + ozone position
% dcfname is dcfile name for brstps.
% fname is data from alldsp
% dcfname is file ontained from savedsp
% outfname is were log should be written

% ozone pos-> from icf
% using read_icf= cfg(14)+cfg(44)
%cfg=read_icf('icf07808.193');
%ozonepos=cfg(14)+cfg(44);

[res2,detail2]=ozonecoeff3([path fnamealldsp],[ozonepos,cfg(44)],[path fname7],[path outfname_cubic]);


%% Power fit vs Quadratic
jcal=find(res(:,1)==cfg(14),1,'first');
disp('Quadratic')
%quad_dsp_coef=printmatrix(res(j,:),4);
 QUAD_SUM=printmatrix(res(jcal,:),4);
 QUAD_DETAIL=printmatrix(detail(:,:,jcal),4);

%disp('Cubic')
%cubic_dsp_coef=printmatrix(res2(j,:),4);
disp('Cubic')
CUBIC_SUM=printmatrix(res2(jcal,:),4);
disp('Cubic')

for ii=-1:1
CUBIC_DETAIL{ii+2}=printmatrix(detail2(:,:,jcal+ii),4);
end

label_1={'slit #0','slit #1','slit #2','slit #3','slit #4','slit #5'};
label_2={sprintf('step= %d ',res(jcal,1));'WL(A)';'Res(A)';'O3abs(1/cm)';'Ray abs(1/cm)';'SO2abs(1/cm)'};
label_r={'step  ','O3abs  ','Rayabs  ','SO2abs  ','O3SO2Abs'};
quad_report=num2cell(res(jcal,1:end-2));
quad_report=[label_r;quad_report]


QUAD_DETAIL=[]; temp_res=[' ',label_r,' '];
for ii=-1:1
label_1={'slit\#0','slit\#1','slit\#2','slit\#3','slit\#4','slit\#5'};
label_2={sprintf('step= %d ',res(jcal+ii,1));'WL(A)';'Res(A)';'O3abs(1/cm)';'Ray abs(1/cm)';'SO2abs(1/cm)'};
label_r={'step','O3abs','Rayabs','SO2abs','O3SO2Abs'};
    
 detail(1,:,jcal+ii)=round(detail(1,:,jcal+ii));
 step_report=num2cell(detail(1:end-1,:,jcal+ii));
 %  end -2 introducimos daumont
 quad_res=num2cell(res(jcal+ii,1:end-2));
 step_report=[label_2,[label_1;step_report]]
 QUAD_DETAIL=[QUAD_DETAIL;step_report]
 temp_res=[temp_res;[' ',quad_res,' ']];
end
QUAD_DETAIL=[QUAD_DETAIL;temp_res];


disp('Quadratic')
quad_dsp_res=printmatrix(detail(:,:,jcal),4);
disp('Cubic')
cubic_dsp_coef=printmatrix(detail2(:,:,jcal),4);



f4=figure;
set(f4,'Tag','DSP');
% res(1,end-1) los dos ulitimos son el umkher

limits=round([min(res(1:end-2,2))-0.01,max(res2(1:end-2,2))+0.01]*100)/100;
%mmplotyy(res(:,1),res(:,2),limits,res2(:,2),limits);
mmplotyy(res(1:end-2,1),[res(1:end-2,2),res2(1:end-2,2)],limits,[gradient(res(1:end-2,2)),gradient(res2(1:end-2,2))]);
mmplotyy('gradient');
hold on
%mmplotyy(res(:,1),res(:,2),limits,res2(:,2),limits);
xlabel('Calc Step');
title(['Ozone Absortion Coefficient  #', num2str(brewnb)]);
legend('Quadratic','Cubic');


%res=cat(3,res(jcal-2:jcal+2,:),res2(jcal-2:jcal+2,:));
res=cat(3,[res(jcal-2:jcal+2,:);res(end-1:end,:)],[res2(jcal-2:jcal+2,:);res2(end-1:end,:)]);
detail=cat(4,detail(:,:,[jcal-2:jcal+2,end-1:end]),detail(:,:,[jcal-2:jcal+2,end-1:end]));



##### SOURCE END #####
-->
   </body>
</html>