
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
      <!--
This HTML is auto-generated from an M-file.
To make changes, update the M-file and republish this document.
      -->
      <title>sl_report_jday</title>
      <meta name="generator" content="MATLAB 7.7">
      <meta name="date" content="2009-01-21">
      <meta name="m-file" content="sl_report_jday"><style type="text/css">

body {
  background-color: white;
  margin:10px;
}

h1 {
  color: #990000; 
  font-size: x-large;
}

h2 {
  color: #990000;
  font-size: medium;
}

/* Make the text shrink to fit narrow windows, but not stretch too far in 
wide windows. */ 
p,h1,h2,div.content div {
  max-width: 600px;
  /* Hack for IE6 */
  width: auto !important; width: 600px;
}

pre.codeinput {
  background: #EEEEEE;
  padding: 10px;
}
@media print {
  pre.codeinput {word-wrap:break-word; width:100%;}
} 

span.keyword {color: #0000FF}
span.comment {color: #228B22}
span.string {color: #A020F0}
span.untermstring {color: #B20000}
span.syscmd {color: #B28C00}

pre.codeoutput {
  color: #666666;
  padding: 10px;
}

pre.error {
  color: red;
}

p.footer {
  text-align: right;
  font-size: xx-small;
  font-weight: lighter;
  font-style: italic;
  color: gray;
}

  </style></head>
   <body>
      <div class="content">
         <h2>Contents</h2>
         <div>
            <ul>
               <li><a href="#3">PLOT</a></li>
            </ul>
         </div><pre class="codeinput"><span class="comment">%function [sl_s,slavg,oulier,R6]=sl_report(idx_inst,sl,brw_name,fplot)</span>
<span class="comment">%</span>
<span class="comment">% sl_s-&gt; summary: daily median  oulier removed and interpolated values of mising days</span>
<span class="comment">%      -&gt;time and (median,std ) of 'R6','R5','T','F1','F5';</span>
<span class="comment">% slavg -&gt;time and (median,std ) of 'R6','R5','T','F1','F5';</span>
<span class="comment">% outlier-&gt; 3 sigma oulier removed</span>
<span class="comment">% R6: R6 outlier removed individual measurements</span>
<span class="comment">%</span>
<span class="comment">%  se llama desde ozone report</span>

<span class="keyword">function</span> [sl_s,slavg,oulier,R6]=sl_report(idx_inst,sl,brw_name,date_range,fplot)
</pre><pre class="codeinput"><span class="comment">% leemos las medidas individuales</span>
sls=cell2mat(sl{idx_inst});



<span class="keyword">if</span> exist(<span class="string">'date_range'</span>) &amp; ~isempty(date_range)
    j=find(sls(:,1)&lt;date_range(1));
    sls(j,:)=NaN;
    <span class="keyword">if</span> length(date_range)&gt;1
        j=find(sls(:,1)&gt;date_range(2));
        sls(j,:)=NaN;
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">%jok hg before and after</span>
jok=find(sls(:,2)==1);
<span class="keyword">if</span> isempty(jok)
    disp(<span class="string">'Warning no SL ok'</span>);
    jok=ones(size(sls(:,2)));
<span class="keyword">end</span>
<span class="comment">% oulier % remove 3 sigma outlier</span>

 [ax,bx,cx,dx]=outliers_bp(sls(:,22),3);
 <span class="comment">%if idx_inst~=4 %%%%%%%%%%%%%%%%%%%%%%%%%% &iuml;&iquest;&frac12;?</span>
   sls(dx,[22,21,13,23,24])=NaN;
 <span class="comment">%end</span>

  oulier{1,1}=datestr(sls(dx,1));
  oulier{1,2}=sls(dx,:);
  R6=sls(jok,[1,22,13]);


<span class="comment">% Recalculated statistics counts</span>
cname={<span class="string">'R6'</span>,<span class="string">'R5'</span>,<span class="string">'T'</span>,<span class="string">'F1'</span>,<span class="string">'F5'</span>};
ncols=[22,21,13,23,24];

<span class="keyword">try</span>
    [m,s]=grpstats(sls(jok,[1,22,21,13,23,24]),diaj(sls(jok,1)),{@median,<span class="string">'std'</span>});
<span class="keyword">catch</span>

    [m,s]=grpstats(sls(jok,[1,22,21,13,23,24]),diaj(sls(jok,1)),{<span class="string">'mean'</span>,<span class="string">'std'</span>});
    <span class="keyword">for</span> i=1:5
        med=grpstats(sls(jok,ncols(i)),diaj(sls(jok,1)),{@median});
        m(:,i+1)=med;
    <span class="keyword">end</span>

<span class="keyword">end</span>

slavg=orgavg([m,s]); <span class="comment">%time and (mean,std ) of 'R6','R5','T','F1','F5';</span>
slavg(:,2)=[];
<span class="keyword">if</span> size(slavg,1)&gt;5
  sl_s=interp_sm(slavg);
<span class="keyword">else</span>
  sl_s=slavg;
<span class="keyword">end</span>
sl_s(:,1)=sl_s(:,1)+.5;
</pre><pre class="codeoutput">Input argument "idx_inst" is undefined.

Error in ==&gt; sl_report_jday at 14
sls=cell2mat(sl{idx_inst});
</pre><h2>PLOT<a name="3"></a></h2><pre class="codeinput"><span class="keyword">if</span> nargin==5
   <span class="keyword">if</span> fplot==1
</pre><pre class="codeinput">    cname={<span class="string">'R6'</span>,<span class="string">'F1'</span>,<span class="string">'F5'</span>,<span class="string">'T'</span>};
    ncols=[22,23,24,13];
    figure;
    <span class="keyword">for</span> i=1:4
        subplot(2,2,i)
        boxplot(sls(:,ncols(i)),diaj(sls(:,1)));
        title([cname{i},<span class="string">' '</span>,brw_name{idx_inst}]);

    <span class="keyword">end</span>
    <span class="comment">%sls_(:,1)=diaj2(sls(:,1));</span>

    f=figure;
    set(f,<span class="string">'tag'</span>,<span class="string">'SL_R6_report'</span>);
    slaux=sl_s;
    slaux(:,1)=diaj2(slaux(:,1));
    p1=errorbard(slaux(:,1:3),<span class="string">'s'</span>);
    <span class="comment">%set(p1(1),'Linewidth',3);</span>
    hold <span class="string">on</span>
    <span class="comment">%p2=stairs(diaj(slavg(:,1)),slavg(:,2),'o-','LineWidth',2);</span>
    p2=plot(diaj(slavg(:,1)),slavg(:,2),<span class="string">'o-'</span>,<span class="string">'LineWidth'</span>,1);
    p3=plot(diaj2(sls(:,1)),sls(:,22),<span class="string">'.'</span>);
    legend([p1(1),p2,p3],<span class="string">'R6 smooth 7'</span>,<span class="string">'R6 daily mean '</span>,<span class="string">'R6 measures'</span>);
    title([<span class="string">'Standard Lamp R6   '</span>,brw_name{idx_inst}]);
    <span class="comment">%datetick('x','mm/dd','keeplimits','keepticks');</span>
    <span class="comment">%suptitle('SAUNA 2    -Sodankyla 2007-');</span>
    grid;
    xlabel(<span class="string">'Date'</span>)
    ylabel(<span class="string">'SL R6  ratios'</span>);
</pre><pre class="codeinput">    f=figure;
    set(f,<span class="string">'tag'</span>,<span class="string">'SL_R5_report'</span>);
    p1=errorbard(slaux(:,[1,4,5]),<span class="string">'s'</span>);
    <span class="comment">%set(p1(1),'Linewidth',2);</span>
    hold <span class="string">on</span>
    p2=plot(diaj(slavg(:,1)),slavg(:,4),<span class="string">'o-'</span>,<span class="string">'LineWidth'</span>,1);
    p3=plot(diaj2(sls(:,1)),sls(:,21),<span class="string">'.:'</span>);
    legend([p1(1),p2,p3],<span class="string">'R5 smooth 7'</span>,<span class="string">'R5 daily mean '</span>,<span class="string">'R5 measures'</span>);
    title([<span class="string">'Standard Lamp R5   '</span>,brw_name{idx_inst}]);
    <span class="comment">%datetick('x','mm/dd','keeplimits','keepticks');</span>
    <span class="comment">%suptitle('SAUNA 2    -Sodankyla 2007-');</span>
    grid;
    xlabel(<span class="string">'Date'</span>)
    ylabel(<span class="string">'SL R5  ratios'</span>);

    <span class="comment">% INT</span>
    f=figure;
    set(f,<span class="string">'tag'</span>,<span class="string">'SL_I5_report'</span>);
    p1=errorbard(slaux(:,[1,8:9]),<span class="string">'s'</span>);
    <span class="comment">%set(p1(1),'Linewidth',3);</span>
    hold <span class="string">on</span>
    p2=plot(diaj(slavg(:,1)),slavg(:,8),<span class="string">'o-'</span>,<span class="string">'LineWidth'</span>,1);
    p3=plot(diaj2(sls(:,1)),sls(:,23),<span class="string">'.'</span>);
    <span class="comment">%legend([p1(1),p2,p3],'I_5 smooth 7','I_5 daily mean ','I_5 meas');</span>
    legend([p1(1),p2,p3],<span class="string">'I_5 smooth 7'</span>,<span class="string">'I_5 daily mean '</span>,<span class="string">'I_5 meas'</span>);
    title([<span class="string">'Standard Lamp I_5   '</span>,brw_name{idx_inst}]);
    <span class="comment">%datetick('x','mm/dd','keeplimits','keepticks');</span>
    <span class="comment">%suptitle('SAUNA 2    -Sodankyla 2007-');</span>
    grid;
    xlabel(<span class="string">'Date'</span>)
    ylabel(<span class="string">'SL I_5  ratios'</span>);


    <span class="comment">% INT</span>
    f=figure;
    set(f,<span class="string">'tag'</span>,<span class="string">'SL_TEMP_report'</span>);
    <span class="comment">%suptitle('SAUNA 2    -Sodankyla 2007-');</span>
    title([<span class="string">'Standard Lamp R6 vs temperature   '</span>,brw_name{idx_inst}]);
    set(f,<span class="string">'tag'</span>,<span class="string">'SL_TEMP_report'</span>);
    gscatter(sls(:,13),sls(:,22),5*fix(diaj(sls(:,1))/5));
    title([<span class="string">'Standard Lamp R6 vs temperature   '</span>,brw_name{idx_inst}]);

    grid;
    xlabel(<span class="string">'PMT Temperature (C\circ)'</span>);
    ylabel(<span class="string">'SL R6 ratios'</span>);
</pre><pre class="codeinput">   <span class="keyword">end</span>

<span class="keyword">end</span>


<span class="comment">%function rdata=orgavg(data)</span>
<span class="comment">% reorganiza las matrices (media_1,media_2,media_3..media_n, ...</span>
<span class="comment">% sigma_1,sigma_2,sigma_3....sigma_n.) a</span>
<span class="comment">% media1, sigma1 , media2 sigma2</span>
</pre><pre class="codeinput"><span class="keyword">function</span> rdata=orgavg(data)
idx=1:size(data,2)/2;
idx=sort([idx,idx]);
idx(2:2:end)=idx(2:2:end)+size(data,2)/2;
rdata=data(:,idx);


<span class="comment">% function data=interp_smooth(data_avg)</span>
<span class="comment">% funcion que interpola la serie previamente suavizada</span>
<span class="comment">% utilizada para rellenar huecos los valores de standard lamp.</span>


<span class="keyword">function</span> data=interp_sm(data_avg,N_dat)
<span class="keyword">if</span> nargin==1
   N_dat=15; <span class="comment">%suavizado</span>
<span class="keyword">end</span>
<span class="comment">%if nargin==1</span>
   x0=min(fix(data_avg(:,1)));
   x1=max(fix(data_avg(:,1)));
   x=x0:x1;


   <span class="comment">%la interpolacion no permite nan</span>
   <span class="comment">% el suavizado si &iuml;&iquest;&frac12;?</span>
   j=find(isnan(data_avg(:,1)));
   <span class="keyword">if</span> ~isempty(j)
     data_avg(j,:)=[];
   <span class="comment">% rellenamos con  la mediana</span>
     <span class="keyword">for</span> ii=2:size(data_avg,2)
     data_avg(isnan(data_avg(:,ii)),ii)=nanmedian(data_avg(:,ii));
     <span class="keyword">end</span>
   <span class="keyword">end</span>

  <span class="comment">%suavizado</span>
  <span class="comment">% aux=repmat(data_avg(:,1),1,size(data_avg(:,2:end),2));</span>
  <span class="comment">%for i=1:size(data_avg,2)-1;</span>
  <span class="comment">% data_avg(:,i+1)=smooth(data_avg(:,1),data_avg(:,i+1),N_dat,'rlowess');</span>
  <span class="comment">%end</span>

    data=interp1(data_avg(:,1),data_avg(:,2:end),x,<span class="string">'pchip'</span>);
    data=[x',data];
</pre><pre class="codeoutput">WDEavRCxrA000020000</pre><p class="footer"><br>
            Published with MATLAB&reg; 7.7<br></p>
      </div>
      <!--
##### SOURCE BEGIN #####
%function [sl_s,slavg,oulier,R6]=sl_report(idx_inst,sl,brw_name,fplot)
%
% sl_s-> summary: daily median  oulier removed and interpolated values of mising days
%      ->time and (median,std ) of 'R6','R5','T','F1','F5';
% slavg ->time and (median,std ) of 'R6','R5','T','F1','F5';
% outlier-> 3 sigma oulier removed
% R6: R6 outlier removed individual measurements
%
%  se llama desde ozone report

function [sl_s,slavg,oulier,R6]=sl_report(idx_inst,sl,brw_name,date_range,fplot)

% leemos las medidas individuales 
sls=cell2mat(sl{idx_inst});



if exist('date_range') & ~isempty(date_range)
    j=find(sls(:,1)<date_range(1));
    sls(j,:)=NaN;
    if length(date_range)>1
        j=find(sls(:,1)>date_range(2));
        sls(j,:)=NaN;
    end
end

%jok hg before and after
jok=find(sls(:,2)==1);
if isempty(jok)
    disp('Warning no SL ok');
    jok=ones(size(sls(:,2)));
end
% oulier % remove 3 sigma outlier

 [ax,bx,cx,dx]=outliers_bp(sls(:,22),3);
 %if idx_inst~=4 %%%%%%%%%%%%%%%%%%%%%%%%%% ï¿½?
   sls(dx,[22,21,13,23,24])=NaN;
 %end

  oulier{1,1}=datestr(sls(dx,1));
  oulier{1,2}=sls(dx,:);
  R6=sls(jok,[1,22,13]);


% Recalculated statistics counts
cname={'R6','R5','T','F1','F5'};
ncols=[22,21,13,23,24];

try
    [m,s]=grpstats(sls(jok,[1,22,21,13,23,24]),diaj(sls(jok,1)),{@median,'std'});
catch

    [m,s]=grpstats(sls(jok,[1,22,21,13,23,24]),diaj(sls(jok,1)),{'mean','std'});
    for i=1:5
        med=grpstats(sls(jok,ncols(i)),diaj(sls(jok,1)),{@median});
        m(:,i+1)=med;
    end

end

slavg=orgavg([m,s]); %time and (mean,std ) of 'R6','R5','T','F1','F5';
slavg(:,2)=[];
if size(slavg,1)>5
  sl_s=interp_sm(slavg);
else
  sl_s=slavg;
end
sl_s(:,1)=sl_s(:,1)+.5;

%% PLOT
if nargin==5
   if fplot==1
    cname={'R6','F1','F5','T'};
    ncols=[22,23,24,13];
    figure;
    for i=1:4
        subplot(2,2,i)
        boxplot(sls(:,ncols(i)),diaj(sls(:,1)));
        title([cname{i},' ',brw_name{idx_inst}]);

    end
    %sls_(:,1)=diaj2(sls(:,1));
    
    f=figure;
    set(f,'tag','SL_R6_report');
    slaux=sl_s;
    slaux(:,1)=diaj2(slaux(:,1)); 
    p1=errorbard(slaux(:,1:3),'s');
    %set(p1(1),'Linewidth',3);
    hold on
    %p2=stairs(diaj(slavg(:,1)),slavg(:,2),'o-','LineWidth',2);
    p2=plot(diaj(slavg(:,1)),slavg(:,2),'o-','LineWidth',1);
    p3=plot(diaj2(sls(:,1)),sls(:,22),'.');
    legend([p1(1),p2,p3],'R6 smooth 7','R6 daily mean ','R6 measures');
    title(['Standard Lamp R6   ',brw_name{idx_inst}]);
    %datetick('x','mm/dd','keeplimits','keepticks');
    %suptitle('SAUNA 2    -Sodankyla 2007-');
    grid;
    xlabel('Date')
    ylabel('SL R6  ratios');

    %%
    f=figure;
    set(f,'tag','SL_R5_report');
    p1=errorbard(slaux(:,[1,4,5]),'s');
    %set(p1(1),'Linewidth',2);
    hold on
    p2=plot(diaj(slavg(:,1)),slavg(:,4),'o-','LineWidth',1);
    p3=plot(diaj2(sls(:,1)),sls(:,21),'.:');
    legend([p1(1),p2,p3],'R5 smooth 7','R5 daily mean ','R5 measures');
    title(['Standard Lamp R5   ',brw_name{idx_inst}]);
    %datetick('x','mm/dd','keeplimits','keepticks');
    %suptitle('SAUNA 2    -Sodankyla 2007-');
    grid;
    xlabel('Date')
    ylabel('SL R5  ratios');

    % INT
    f=figure;
    set(f,'tag','SL_I5_report');
    p1=errorbard(slaux(:,[1,8:9]),'s');
    %set(p1(1),'Linewidth',3);
    hold on
    p2=plot(diaj(slavg(:,1)),slavg(:,8),'o-','LineWidth',1);
    p3=plot(diaj2(sls(:,1)),sls(:,23),'.');
    %legend([p1(1),p2,p3],'I_5 smooth 7','I_5 daily mean ','I_5 meas');
    legend([p1(1),p2,p3],'I_5 smooth 7','I_5 daily mean ','I_5 meas');
    title(['Standard Lamp I_5   ',brw_name{idx_inst}]);
    %datetick('x','mm/dd','keeplimits','keepticks');
    %suptitle('SAUNA 2    -Sodankyla 2007-');
    grid;
    xlabel('Date')
    ylabel('SL I_5  ratios');


    % INT
    f=figure;
    set(f,'tag','SL_TEMP_report');
    %suptitle('SAUNA 2    -Sodankyla 2007-');
    title(['Standard Lamp R6 vs temperature   ',brw_name{idx_inst}]);
    set(f,'tag','SL_TEMP_report');
    gscatter(sls(:,13),sls(:,22),5*fix(diaj(sls(:,1))/5));
    title(['Standard Lamp R6 vs temperature   ',brw_name{idx_inst}]);

    grid;
    xlabel('PMT Temperature (C\circ)');
    ylabel('SL R6 ratios');
   end

end


%function rdata=orgavg(data)
% reorganiza las matrices (media_1,media_2,media_3..media_n, ...
% sigma_1,sigma_2,sigma_3....sigma_n.) a
% media1, sigma1 , media2 sigma2
function rdata=orgavg(data)
idx=1:size(data,2)/2;
idx=sort([idx,idx]);
idx(2:2:end)=idx(2:2:end)+size(data,2)/2;
rdata=data(:,idx);


% function data=interp_smooth(data_avg)
% funcion que interpola la serie previamente suavizada
% utilizada para rellenar huecos los valores de standard lamp.


function data=interp_sm(data_avg,N_dat)
if nargin==1
   N_dat=15; %suavizado
end
%if nargin==1
   x0=min(fix(data_avg(:,1)));
   x1=max(fix(data_avg(:,1)));
   x=x0:x1;


   %la interpolacion no permite nan
   % el suavizado si ï¿½?
   j=find(isnan(data_avg(:,1)));
   if ~isempty(j)
     data_avg(j,:)=[];
   % rellenamos con  la mediana
     for ii=2:size(data_avg,2)
     data_avg(isnan(data_avg(:,ii)),ii)=nanmedian(data_avg(:,ii));
     end
   end

  %suavizado
  % aux=repmat(data_avg(:,1),1,size(data_avg(:,2:end),2));
  %for i=1:size(data_avg,2)-1;
  % data_avg(:,i+1)=smooth(data_avg(:,1),data_avg(:,i+1),N_dat,'rlowess');
  %end

    data=interp1(data_avg(:,1),data_avg(:,2:end),x,'pchip');
    data=[x',data];

##### SOURCE END #####
-->
   </body>
</html>